# Database Migrator

This tool is intended to help you to migrate your databases from one to another, be it the same technology or different 
technologies, it uses the power of python with [SqlAlchemy](https://www.sqlalchemy.org/), 
[SqlACodeGen](https://github.com/agronholm/sqlacodegen) and [Alembic](https://alembic.sqlalchemy.org/)

## Architecture

Given a source connection, a destination connection, and a set of tables, this code will generate the models based on
the given tables using sqlacodegen library. Once the models are generated, they will be manipulated to be as generic as 
possible, so we can use them on any database technology, and after that the migrations are generated by Alembic using a diff 
with the destination database. The migrations then are run on destination database (drop tables and columns are ignored
so we can have a safer procedure). With the database structure updated the data can be transfered using entities and the 
merge technique of the SqlAlchemy ORM.

![sequence](docs/sequence.png)
## Instalation

Install poetry

```shell
$ pip install poetry
```

Install dependencies

```shell
$ poetry install
```

## Usage

Configure your environment, you need to inform a conection to the source db and the destination db

```properties
SOURCE_CONNECTION=oracle+cx_oracle://user:passwrod@connection_sring
DESTINATION_CONNECTION=postgresql+psycopg2://postgres:123@localhost/default

BASE_LOGGING_LEVEL=ERROR
SQL_LOGGING_LEVEL=INFO
```

Start a poetry shell

```shell
$ poetry shell
```

This project makes use of invoke to call tasks, the main command is divided on many other commands, so smaller parts of 
the command can be called in isolation, use ``` $ invoke -l ``` to see them all.
To migrate the database structure and migrate all the data just call ```transfer-data```

```shell
$ invoke -h transfer-data
Usage: inv[oke] [--core-opts] transfer-data [--options] [other tasks here ...]

Docstring:
  Transfers data from the source database to the destination database, given the tables specified

Options:
  -d STRING, --destination-schema=STRING   For databases that supports schemas this option can be used to set the destination schema, defaults to public
  -m INT, --max-workers=INT                Maximum number of forked parallel processes to use, defaults to 30 (very machine dependant)
  -p INT, --page-size=INT                  The process will paginate all data and each page runs on a parallel process, this param sets the page size
  -s STRING, --source-schema=STRING        For databases that supports schemas this option can be used to set the source schema, defaults to public
  -t STRING, --tables=STRING               Comma separated source database tables name you wish to migrate to destination database

```

